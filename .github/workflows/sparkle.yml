name: Generate Appcast on Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  generate-appcast:
    runs-on: macos-latest
    steps:
      - name: Checkout Release Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Sparkle
        run: |
          mkdir -p sparkle_bin
          curl -L https://github.com/sparkle-project/Sparkle/releases/download/2.6.4/Sparkle-2.6.4.tar.xz -o Sparkle.tar.xz
          tar -xf Sparkle.tar.xz -C sparkle_bin bin/generate_appcast bin/sign_update
          chmod +x sparkle_bin/bin/generate_appcast sparkle_bin/bin/sign_update

      - name: Download Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download ${{ github.event.release.tag_name }} --pattern "*.dmg" --pattern "*.zip" --dir .

      - name: Generate Appcast
        env:
          SPARKLE_ED25519_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          # Strip all whitespace from the key
          printf "%s" "$SPARKLE_ED25519_PRIVATE_KEY" | tr -d '[:space:]' | ./sparkle_bin/bin/generate_appcast . --ed-key-file -

      - name: Commit and Push Appcast
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add appcast.xml
          # Only commit if appcast.xml changed
          git commit -m "chore: update appcast.xml for release ${{ github.event.release.tag_name }}" || echo "No changes to appcast.xml"
          git push origin HEAD:main
