name: Generate Appcast on Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  generate-appcast:
    runs-on: macos-latest
    steps:
      - name: Checkout Release Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Sparkle
        run: |
          mkdir -p sparkle_bin
          curl -L https://github.com/sparkle-project/Sparkle/releases/download/2.6.4/Sparkle-2.6.4.tar.xz -o Sparkle.tar.xz
          tar -xf Sparkle.tar.xz -C sparkle_bin bin/generate_appcast bin/sign_update
          chmod +x sparkle_bin/bin/generate_appcast sparkle_bin/bin/sign_update

      - name: Download Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download ${{ github.event.release.tag_name }} --pattern "*.dmg" --pattern "*.zip" --dir .

      - name: Debug Key Length
        env:
          SPARKLE_ED25519_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          KEY_LEN=${#SPARKLE_ED25519_PRIVATE_KEY}
          echo "Private Key Length: $KEY_LEN"
          if [ "$KEY_LEN" -lt 10 ]; then
            echo "::error::Key seems too short!"
            exit 1
          fi

      - name: Generate Appcast
        env:
          SPARKLE_ED25519_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          # Use printf to avoid trailing newline, and strip all whitespace from the key
          printf "%s" "$SPARKLE_ED25519_PRIVATE_KEY" | tr -d '[:space:]' | ./sparkle_bin/bin/generate_appcast . --ed-key-file -

      - name: Commit and Push Appcast
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin main
          # Force add artifacts in case .gitignore excludes them
          git add -f appcast.xml *.zip *.dmg
          # Only commit if something changed
          git commit -m "chore: release ${{ github.event.release.tag_name }} artifacts" || echo "No changes to commit"
          git push origin HEAD:main
