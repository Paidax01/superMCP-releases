name: Generate Appcast on Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  generate-appcast:
    runs-on: macos-latest
    steps:
      - name: Checkout Release Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Sparkle
        run: |
          mkdir -p sparkle_bin
          curl -L https://github.com/sparkle-project/Sparkle/releases/download/2.6.4/Sparkle-2.6.4.tar.xz -o Sparkle.tar.xz
          tar -xf Sparkle.tar.xz -C sparkle_bin bin/generate_appcast bin/sign_update
          chmod +x sparkle_bin/bin/generate_appcast sparkle_bin/bin/sign_update

      - name: Download Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download ${{ github.event.release.tag_name }} --pattern "*.dmg" --pattern "*.zip" --dir . --clobber

      - name: Debug Key Length
        env:
          SPARKLE_ED25519_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          KEY_LEN=${#SPARKLE_ED25519_PRIVATE_KEY}
          echo "Private Key Length: $KEY_LEN"
          if [ "$KEY_LEN" -lt 10 ]; then
            echo "::error::Key seems too short!"
            exit 1
          fi

      - name: Generate Release Notes
        env:
          RELEASE_BODY: ${{ github.event.release.body }}
        run: |
          # Find the zip file
          ZIP_PATH=$(find . -maxdepth 1 -name "*.zip" | head -n 1)
          if [ -z "$ZIP_PATH" ]; then
            echo "::warning::No .zip file found. Skipping release notes."
            exit 0
          fi
          
          # Get basename of the zip (e.g. applemcp from applemcp.zip)
          BASENAME=$(basename "$ZIP_PATH" .zip)
          HTML_FILE="$BASENAME.html"
          
          # Simple conversion: wrap markdown in a pre tag for basic display
          # Ideally, you'd use a markdown-to-html converter here
          echo "<html><body>" > "$HTML_FILE"
          echo "<h2>Release Notes</h2>" >> "$HTML_FILE"
          echo "<pre style=\"white-space: pre-wrap; font-family: system-ui;\">" >> "$HTML_FILE"
          echo "$RELEASE_BODY" >> "$HTML_FILE"
          echo "</pre>" >> "$HTML_FILE"
          echo "</body></html>" >> "$HTML_FILE"
          
          echo "Created $HTML_FILE to be picked up by generate_appcast"

      - name: Generate Appcast
        env:
          SPARKLE_ED25519_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          # Use printf to avoid trailing newline, and strip all whitespace from the key
          printf "%s" "$SPARKLE_ED25519_PRIVATE_KEY" | tr -d '[:space:]' | ./sparkle_bin/bin/generate_appcast . --ed-key-file -

      - name: Commit and Push Appcast
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # Force add artifacts, ignoring errors if one type doesn't exist
          git add -f appcast.xml
          git add -f *.zip 2>/dev/null || true
          git add -f *.dmg 2>/dev/null || true
          # Only commit if something changed
          git commit -m "chore: release ${{ github.event.release.tag_name }} artifacts" || echo "No changes to commit"
          git push origin HEAD:main
